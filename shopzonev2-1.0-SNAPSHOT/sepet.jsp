    <%--
      Created by IntelliJ IDEA.
      User: rasim
      Date: 14.12.2024
      Time: 18:49
      To change this template use File | Settings | File Templates.
    --%>
    <%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
    <%@ page import="java.util.List" %>
    <%@ page import="DAO.*" %>
    <%@ page import="DAO.SepetDAO" %>
    <%@ page import="DAO.SepetDAO.UrunSepet" %>
    <%@ page import="java.util.Base64" %>

    <%
        Kullanici aktif = (Kullanici) session.getAttribute("aktif");
        SepetDAO sepetDAO = new SepetDAO(ConnectionManager.getConnection());
        List<SepetDAO.UrunSepet> urunListesi = sepetDAO.SepetiGetir(aktif.getUsername());
        System.out.println(aktif.getUsername());
    %>

    <!DOCTYPE html>

    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ShopZone</title>
        <link rel="stylesheet" href="deneme.css">
        <script>
            function calculateTotal() {
                let total = 0;
                // √úr√ºnlerin fiyat ve adet bilgilerini al
                document.querySelectorAll('.product-card').forEach(product => {
                    const priceElement = product.querySelector('.product-price');
                    const quantityInput = product.querySelector('input[type="text"]');

                    if (priceElement && quantityInput) {
                        const price = parseFloat(priceElement.textContent.replace(' TL', '').trim());
                        const quantity = parseInt(quantityInput.value);
                        total += price * quantity;  // Fiyat * Adet = Toplam fiyat
                    }
                });

                // Toplam tutarƒ± DOM'da g√ºncelle
                document.getElementById('total-price').textContent = total.toFixed(2) + ' TL';
            }

            // Sayfa y√ºklendikten sonra toplam tutarƒ± hesapla
            window.onload = calculateTotal;
            function guncelleAdet(urunId, islem) {
                // Parametre kontrol√º
                console.log("urunId:", urunId, "islem:", islem); // Debug i√ßin ekleme

                if (!urunId || isNaN(urunId)) {
                    console.error("Ge√ßersiz urunId:", urunId);
                    alert("Bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.");
                    return;
                }

                const adetInput = document.getElementById('adet-' + urunId);
                if (!adetInput) {
                    console.error("Adet input elemanƒ± bulunamadƒ±: urunId=", urunId);
                    return;
                }

                let adet = parseInt(adetInput.value);
                if (isNaN(adet)) {
                    console.error("Adet deƒüeri ge√ßersiz:", adetInput.value);
                    alert("Adet bilgisi ge√ßersiz. L√ºtfen sayfayƒ± yenileyin.");
                    return;
                }

                // ƒ∞≈ülem t√ºr√ºne g√∂re adeti g√ºncelle
                if (islem === 'artir') {
                    adet++;
                } else if (islem === 'azalt' && adet > 1) {
                    adet--;
                } else if (islem === 'azalt' && adet === 1) {
                    // Eƒüer adet 1 ve azalt d√ºƒümesine basƒ±ldƒ±ysa √ºr√ºn√º kaldƒ±rmayƒ± teklif et
                    if (!confirm("Bu √ºr√ºn√º sepetinizden kaldƒ±rmak istiyor musunuz?")) {
                        return;
                    }
                    adet = 0;
                }

                // Sunucuya istek g√∂nder
                fetch("adetGuncelle.jsp?urunId=" + urunId + "&yeniAdet=" + adet, {
                    method: 'GET',
                })
                    .then(response => {
                        if (response.ok) {
                            if (adet === 0) {
                                // √úr√ºn kaldƒ±rƒ±ldƒ±ysa DOM'dan kaldƒ±r
                                const urunElement = document.getElementById('urun-' + urunId);
                                if (urunElement) {
                                    urunElement.remove();
                                }
                            } else {
                                // Adedi g√ºncelle
                                adetInput.value = adet;
                            }
                            // Toplam tutarƒ± yeniden hesapla
                            calculateTotal();
                        } else {
                            console.error("Sunucu hatasƒ±:", response.status, response.statusText);
                            alert('Adet g√ºncellenirken bir hata olu≈ütu.');
                        }
                    })
                    .catch(error => {
                        console.error("Fetch hatasƒ±:", error);
                        alert('Adet g√ºncellenirken bir hata olu≈ütu.');
                    });
            }

        </script>

        <script>
            function guncelleAdet(urunId, islem) {
                // Parametre kontrol√º

                    console.log("urunId:", urunId, "islem:", islem); // Debug i√ßin ekleme


                if (!urunId || isNaN(urunId)) {
                    console.error("Ge√ßersiz urunId:", urunId);
                    alert("Bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.");
                    return;
                }

                const adetInput = document.getElementById('adet-' + urunId);
                if (!adetInput) {
                    console.error("Adet input elemanƒ± bulunamadƒ±: urunId=", urunId);
                    return;
                }

                let adet = parseInt(adetInput.value);
                if (isNaN(adet)) {
                    console.error("Adet deƒüeri ge√ßersiz:", adetInput.value);
                    alert("Adet bilgisi ge√ßersiz. L√ºtfen sayfayƒ± yenileyin.");
                    return;
                }

                // ƒ∞≈ülem t√ºr√ºne g√∂re adeti g√ºncelle
                if (islem === 'artir') {
                    adet++;
                } else if (islem === 'azalt' && adet > 1) {
                    adet--;
                } else if (islem === 'azalt' && adet === 1) {
                    // Eƒüer adet 1 ve azalt d√ºƒümesine basƒ±ldƒ±ysa √ºr√ºn√º kaldƒ±rmayƒ± teklif et
                    if (!confirm("Bu √ºr√ºn√º sepetinizden kaldƒ±rmak istiyor musunuz?")) {
                        return;
                    }
                    adet = 0;
                }

                // Sunucuya istek g√∂nder
                fetch("adetGuncelle.jsp?urunId=" + urunId + "&yeniAdet=" + adet, {
                    method: 'GET',
                })

                        .then(response => {
                        if (response.ok) {
                            if (adet === 0) {
                                // √úr√ºn kaldƒ±rƒ±ldƒ±ysa DOM'dan kaldƒ±r
                                const urunElement = document.getElementById('urun-' + urunId);
                                if (urunElement) {
                                    urunElement.remove();
                                }
                            } else {
                                // Adedi g√ºncelle
                                adetInput.value = adet;
                            }
                        } else {
                            console.error("Sunucu hatasƒ±:", response.status, response.statusText);
                            alert('Adet g√ºncellenirken bir hata olu≈ütu.');
                        }
                    })
                    .catch(error => {
                        console.error("Fetch hatasƒ±:", error);
                        alert('Adet g√ºncellenirken bir hata olu≈ütu.');
                    });
            }

        </script>


    </head>
    <body>
    <!-- Header -->
    <header class="header">
        <div class="logo" > <a href="index.jsp" class="logo"> ShopZone </a> </div>
        <div class="search-bar">
            <input type="text" placeholder="√úr√ºn, kategori veya marka ara">
            <button>üîç</button>
        </div>
        <div class="user-actions">
            <%if(aktif!=null){%><h2 class="kullanici">Merhaba, <%= aktif.getUsername() %>! </h2>
            <span class="button">üõí Sepetim</span> <span class="button"> √áƒ±kƒ±≈ü yap</span><%} else{%>
            <span class="login"> <button class="button" onclick="location.href='kayitKontrol.jsp'">üë§ Giri≈ü yap</button></span><%}%>
        </div>
    </header>


    <!-- Main Content -->
    <main class="main-content" >
        <h1 class="button">Sepetiniz:</h1>
        <div class="carousel">

        <div class="container">
            <% if (urunListesi.isEmpty()) { %>
            <p>Sepetinizde hi√ß √ºr√ºn yok.</p>
            <% } else {
                for (UrunSepet urun : urunListesi) { %>
            <div class="product-card" id="urun-<%= urun.urunId %>">
                <img src="data:image/jpeg;base64,<%= urun.resimBase64 %>" alt="<%= urun.urunAdi %>">
                <h3><%= urun.urunAdi %></h3>
                <p>Kategori: <%= urun.kategori %></p>
                <div>
                    <button onclick="guncelleAdet(<%= urun.urunId %>, 'azalt')">-</button>
                    <input type="text" id="adet-<%= urun.urunId %>" value="<%= urun.adet %>" readonly>
                    <button onclick="guncelleAdet(<%= urun.urunId %>, 'artir')">+</button>
                </div>
                <span class="product-price"><%= urun.fiyat %> TL</span> <!-- Fiyat burada yer alacak -->
            </div>


            <!-- Sepet Tutarƒ± G√∂sterimi -->
            <div class="cart-summary">
                <span>Toplam Tutar: <span id="total-price">0.00 TL</span></span>
            </div>

        </div>
            <% }
            } %>
        </div>
        <form action="siparisTamamla.jsp" method="POST">
            <button type="submit" class="button">Sipari≈üi Tamamla</button>
        </form>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© 2024 ShopZone - T√ºm haklarƒ± saklƒ±dƒ±r.</p>
    </footer>
    </body>
    </html>

